---
title: "Project 1"
author: "Matt Fein, Jeffrey Jou, Polly McKim, Pancea Motawi, and Elise Roberts"
date: "October 14, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=F}
require(tidyr)
require(formattable) #Format prices to currency
require(stringr)
require(ggplot2) # Package for data visualization
require(pander) # Package to make 
require(reshape2) # Additional package for data manipulation
require(plyr) # Additional package for data manipulation
require(dplyr) # Additional package for data manipulation
require(leaflet)

outlierKD <- function(dt, var, rmv=NULL) { 
     var_name <- eval(substitute(var),eval(dt))
     na1 <- sum(is.na(var_name))
     m1 <- mean(var_name, na.rm = T)
     sd1 <- sd(var_name,na.rm = T)
     par(mfrow=c(2, 2), oma=c(0,0,3,0))
     boxplot(var_name, main="With outliers")
     hist(var_name, main="With outliers", xlab=NA, ylab=NA)
     outlier <- boxplot.stats(var_name)$out
     mo <- mean(outlier)
     var_name <- ifelse(var_name %in% outlier, NA, var_name)
     boxplot(var_name, main="Without outliers")
     hist(var_name, main="Without outliers", xlab=NA, ylab=NA)
     title("Outlier Check", outer=TRUE)
     na2 <- sum(is.na(var_name))
     cat("Outliers identified:", na2 - na1, "n")
     cat("Propotion (%) of outliers:", round((na2 - na1) / sum(!is.na(var_name))*100, 1), "n")
     cat("Mean of the outliers:", round(mo, 2), "n")
     m2 <- mean(var_name, na.rm = T)
     cat("Mean without removing outliers:", round(m1, 2), "n")
     cat("Mean if we remove outliers:", round(m2, 2), "n")
     #
     if(is.null(rmv)) { 
       response <- readline(prompt="Do you want to remove outliers and to replace with NA? [yes/no]: ") 
     } else {
       if (rmv=='y'|rmv=='yes'|rmv=='Y'|rmv=='Yes'|rmv=='YES'|rmv==TRUE ) { response = 'y' } else { response = 'n' }
     }
     #
     if(response == "y" | response == "yes"){
          dt[as.character(substitute(var))] <- invisible(var_name)
          assign(as.character(as.list(match.call())$dt), dt, envir = .GlobalEnv)
          cat("Outliers successfully removed", "n")
          return(invisible(dt))
     } else{
          cat("Nothing changed", "n")
          return(invisible(var_name))
     }
}
```

# Chapter 1: Introduction 

Founded in 2008, Airbnb bills itself as an online marketplace for renting or listing accommodations in cities around the world. While the company has recently started listing tourism experiences in addition to available lodgings, most of the company’s revenue is generated by connecting people who want to rent a lodging with those who have a spare lodging available. Airbnb boasted a valuation of \$31 billion in 2017, and reported a revenue of \$2.5 billion for 2017, the last full year for which Airbnb has released data. Recent quarterly specific revenues released by the company exceed \$1 billion. Airbnb emphasizes that its platform provides travelers with a more cost effective and “local” way to travel while giving “hosts” the opportunity to earn additional income. In Washington, DC, Airbnb hosts earned a reported $96 million from hosting on the site in 2018. This project explores data Airbnb listings in Washington, DC published on July 15, 2019 from Inside Airbnb, and independent, non-commercial set of data that allows users to explore how Airbnb is really being used in cities around the world. We analyzed data related to room type offered, neighborhoods where Airbnb’s were located, room price, and use the number of reviews as a proxy variable for popularity. From a consumer perspective, we would like to discover the interactions between price and popularity, price and room type, price and neighborhood, popularity and neighborhood, as well as room type and neighborhood, in order to book the most cost-effective, popular room in the best neighborhood.

# Chapter 2: Description of Data
## 2.1 Source Data

The data for this project is from InsideAirbnb.com. This website contains information sourced by Murray Cox, who utilized Airbnb’s public application programming interface (API) to mine this data. Originally, Cox scraped this data to identify illegal listings in New York City. He has since expanded his data set offerings to cities across the world and makes this datum available for open source use and research.   

Although Cox is potentially a biased source, due to his activist leanings, his datasets originate from Airbnb themselves and are thoroughly documented. We also considered using data from Airbnb directly, however, other studies have shown that this data is outdated and biased in that it only shows the positive side of Airbnb. Mr. Cox, however, seeks to use the company’s own data is that he scraped from the website itself through a well-documented procedure to explore how Airbnb is really affecting our community. Therefore, we decided that the dataset was reliable because of the author's documentation and his purpose for releasing it. 

```{r load_data, echo=F}
listing <- read.csv("listings.csv")
str(listing)
apartmentsOwned <- table(listing$host_id)
apartmentsOwned <- apartmentsOwned [apartmentsOwned >= 3]
length(apartmentsOwned)
```

The variables included in this dataset include:  
  - Airbnb ID Number  
  - Listing Name  
  - Host ID Number  
  - Neighborhood  
  - Latitude  
  - Longitude  
  - Room Type  
  - Price  
  - Minimum Nights  
  - Number of Reviews  
  - Last Review Date  
  - Reviews per Month  
  - Calculated Host Listings  
  - Availability 365 Days a Year  

# Chapter 3: Exploratory Data Analysis
## 3.1 Do the number of reviews differ by room type?

```{r remove_outliers, include=F}
outlierKD(listing, price, 'y')
outlierKD(listing, number_of_reviews, 'y')
```

> outlierKD(listing, price)  
> outlierKD(listing, number_of_reviews)

First, we removed any outliers in the number of reviews variable of the dataset using the outlierKD function courtesy of Dr. Lo. Then we explore the data through basic charts, starting with a boxplot of the number of reviews grouped by room type. The variable "room_type" is a factor variable with 3 levels: Entire home/apt, private room, and shared room. 

``` {r room_to_reviews_box, echo=F}
# Plot boxplot of number of reviews by room type
room_to_reviews <- ggplot(listing, aes(x = as.factor(room_type), y = number_of_reviews, color = room_type)) +
  geom_boxplot() + 
  theme_bw() + 
  labs(x = "Room Type",
       y = "Number of Reviews",
       color = "Room Type") 
print(room_to_reviews + ggtitle("Boxplot of Number of Reviews by Room Type")) # Print boxplot with title
```

As you can see from the boxplots above, the means and interquartile ranges of the three room types plotted against number of reviews differ marginally. The number of reviews for entire homes seems to be slightly higher than that of the shared rooms.

``` {r ANOVA_room_review, echo =F}
# ANOVA test to see if mean number of reviews is different between room types
# Conclusion: statistically significant, reject null hypothesis
anova_room_review <- aov(number_of_reviews ~ as.factor(room_type), data = listing)
pander(anova_room_review)
# Tukey HSD test to determine which of the room types are pairwise considered different
# Conclusion: Private to entire home  different
# Conclusion: Shared to entire home and shared to private room not different
tukey_room_review <- TukeyHSD(anova_room_review)
tukey_room_review
```

When comparing the mean number of reviews by room type, we see that there is a statistically significant difference between all three room types based on the p-value of 0.02. Therefore, we reject the null hypothesis that the mean number of reviews are the same by room type. However, when we ran a Tukey test to test the significance of the three means against each other individually, we found that no comparison rendered a statistically significant difference in mean number of reviews by room type.

## 3.2 Does the price of a room differ by room type?

To begin, we start with another visualization of price by room type using another boxplot.

``` {r price_to_room_type, echo=F, warning=F}
# Boxplot of price by room type
price_to_room_type <- ggplot(listing, aes(x = factor(room_type), y = price, color = room_type)) +
  geom_boxplot() + 
  theme_bw() +
  labs(x = "Room Type",
       y = "Price",
       color = "Room Type")
print(price_to_room_type + ggtitle("Boxplot of Price by Room Type")) # Print boxpot with title
```

The boxplot clearly demonstrates a dramatic difference in the mean price by room type. It is important to note that none of the means are even within the interquartile range of the room type, as all of them are so vastly distinct from the other.

``` {r ANOVA_room_price, echo=F}
# One-way ANOVA test to see if mean prices are different between room types
# Conclusion: statistically significant, reject null hypothesis
anova_room_price <- aov(price ~ as.factor(room_type), data = listing)
pander(anova_room_price) # Print formatted table
# Tukey HSD test to determine which of the room types are pairwise considered different
# Conclusion: all different from one another 
tukey_room_price <- TukeyHSD(anova_room_price)
tukey_room_price
```

The above ANOVA tests confirms that the mean price differs by room type with a p-value of zero, which is the most statistically significant result possible. Additionally, when mean prices by room type are compared by each other, all of the p-values for these interactions are zero as well. Therefore, we reject the null hypothesis that the mean prices are the same by room type.

## 3.3 How do prices differ by neighborhood?

``` {r bar_clean, include=F}
# Separate neighborhoods by unit id
neighborhood <- 
  as.data.frame(listing) %>%
  select(id, price, neighbourhood)
neighborhood <- separate(neighborhood, neighbourhood, into = c("N1", "N2", "N3"), sep = ",")
neighborhood <-melt(neighborhood, 
       id.vars = c("id", "price"),
       variable.name = "neighborhood",
       na.rm=T) %>%
  arrange(id) 
names(neighborhood) <- c("id", "price", "number", "neighborhood")
```

The following displays three separate maps, colored by rate per night. The first map displays all properties regardless of type of Airbnb (room or apartment). The second map displays only rooms for rent, and the third is for entire apartments available on Airbnb. 

```{r maps, echo=FALSE}
listings <- listing
listings <- listings %>% drop_na("price")
my_map <- leaflet(options = leafletOptions(preferCanvas = TRUE))
listingsSmall <- subset(listings, number_of_reviews > 50)
listings$last_review <- as.Date(listings$last_review, format = "%Y-%m-%d")
listingsRooms <- listingsSmall %>% filter(str_detect(room_type, "oom"))
listingsApart <- listingsSmall %>% filter(str_detect(room_type,"home"))

beatColAll <- colorBin(palette = 'RdYlBu', domain = listingsSmall$price, bins = 6)
beatColRooms <- colorBin(palette = 'RdYlBu', domain = listingsRooms$price, bins = 6)
beatColApart <- colorBin(palette = 'RdYlBu', domain = listingsApart$price, bins = 6)

all_map <- leaflet(listingsSmall) %>%
  addTiles() %>% 
  addCircleMarkers(lat = listingsSmall$latitude, 
            lng = listingsSmall$longitude, 
            color = ~beatColAll(price),
            popup = listingsSmall$name,
            radius=4,
            opacity = .8) %>%
  addLegend(pal = beatColAll, values = ~listingsSmall$price, 
            labFormat = labelFormat(prefix = "$"), title = "All D.C. AirBnbs Rooms Colored by Price")

room_map <- leaflet(listingsRooms) %>%
  addTiles() %>% 
  addCircleMarkers(lat = listingsRooms$latitude, 
            lng = listingsRooms$longitude, 
            color = ~beatColRooms(price),
            popup = listingsRooms$name,
            radius=4,
            opacity = .8) %>%
  addLegend(pal = beatColRooms, values = ~listingsRooms$price, labFormat = labelFormat(prefix = "$"), title = "D.C. AirBnbs Rooms Colored by Price")

apart_map <- leaflet(listingsApart) %>%
  addTiles() %>% 
  addCircleMarkers(lat = listingsApart$latitude, 
            lng = listingsApart$longitude, 
            color = ~beatColApart(price),
            popup = listingsApart$name,
            radius=4,
            opacity = .8) %>%
  addLegend(pal  = beatColApart, values = ~listingsApart$price,
            labFormat = labelFormat(prefix = "$"), 
            title = "D.C. AirBnbs Apartments Colored by Price")
all_map
room_map
apart_map
```

``` {r freq_table, echo=F}
# Histogram of number of AirBnBs by neighborhood
freq_table <- 
  neighborhood %>%
  group_by(neighborhood) %>%
  count() %>%
  arrange(-n)
top_15 <- subset(freq_table, n > quantile(freq_table$n, 0.85))
```

``` {r neigh_bar, echo=F}
neigh_bar <- ggplot(top_15, aes(x = neighborhood, y = n)) +
  geom_bar(aes(fill=neighborhood), stat="identity") + 
  theme_bw() + 
  labs(x = "Neighborhood",
       y = "Number of AirBnbs",
       fill = "Neighborhood") + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) + 
  scale_x_discrete(labels = abbreviate)
print(neigh_bar + ggtitle("Top 15 Most Popular AirBnB Neighborhoods")) # Print bar chart
```

To simplify our analysis of neighborhoods by price, we subsetted our dataset to contain only the top 15 most popular neighborhoods for Airbnbs in DC. We used all listings not previously removed as outliers for the following neighborhoods—Bloomingdale, Connecticut Avenue/K Street, Kingman Park, Lincoln Park, Logan Circle, Mt. Pleasant, Stanton Park, Truxton Park, Capitol Hill, Columbia Heights, Dupont Circle, Edgewood, Shaw, Union Station.  

The bar chart above demonstrates the number of Airbnb listings in each of the top 15 neighborhoods in Washington, D.C. The neighborhoods with the highest concentration of Airbnb listings are Mt. Pleasant, Pleasant Plains, and Columbia Heights - which are all mostly residential neighborhoods in D.C.

``` {r neighborhood_scatter, echo=F}
# Scatterplot of mean price by neighborhood
price_table <- na.omit(neighborhood)
price_table <-
  price_table %>%
  group_by(neighborhood) %>%
  mutate(mean_price = mean(price, na.rm=T))
price_table <- match_df(price_table, top_15, on = "neighborhood")
price_to_neigh <- ggplot(price_table, aes(x = neighborhood, y = mean_price)) +
  geom_point(aes(color = neighborhood)) +
  theme_bw() + 
  labs(x = "Neighborhood",
       y = "Mean Price",
       color = "Neighborhood") + 
  theme(axis.text.x = element_blank())+
  scale_x_discrete(labels = abbreviate)
print(price_to_neigh + ggtitle("Average Price of Top 15 Most Popular Neighborhoods"))
```

The above scatterplot shows the distribution of mean price by neighborhood. As you can see, there is a large gap between the lowest priced neighborhoods and higher priced neighborhoods. The lowest priced neighborhoods include Bloomingdale, Mt. Pleasant, Pleasant Plains, Truxton Circle, Columbia Heights, and Edgewood. 

``` {r price_to_neigh_box, echo=F}
# Boxplot of price by neighborhood
price_to_neigh_box <- ggplot(price_table, aes(x = neighborhood, y = price, color = neighborhood)) + 
  geom_boxplot() + 
  theme_bw() +
  labs(x = "Neighborhood",
       y = "Price",
       color = "Neighborhood") +
  theme(axis.text.x = element_blank()) + 
  scale_x_discrete(labels = abbreviate)
print(price_to_neigh_box + ggtitle("Boxplot of Price by Top 15 Most Popular Neighborhoods"))
```

The boxplot above demonstrates the distribution of prices by the top 15 neighborhoods. Based on this visualization, it is clear that the mean price varies greatly between some neighborhoods, while other neighborhoods seem to be nearly identical. 

``` {r ANOVA_price_neigh, echo=F}
# One-way ANOVA test to see if mean prices are different among neighborhoods
# Conclusion: Statistically significant, reject the null hypothesis
anova_price_neigh <- aov(price ~ as.factor(neighborhood), data = price_table)
pander(anova_price_neigh)
# Tukey HSD test to see which neighborhoods are pairwise different
# Lots of stuff
tukey_price_neigh <- TukeyHSD(anova_price_neigh)
tukey_price_neigh
```

Based on the results of the ANOVA test between mean prices and the top 15 neighborhoods, we got a statistically significant p-value of 1.963e-57. Therefore, we reject the null hypothesis that the mean prices for each of the top 15 neighborhoods are the same.

## 3.4 How does the number of reviews affect price?

``` {r price_to_reviews, echo=F}
# Bin the number of reviews by 25 review bins
listing$bins <- cut(listing$number_of_reviews, breaks = seq(0, 120, 10))
listing <- subset(listing, number_of_reviews > 0) 
listing <- 
  listing %>%
  group_by(bins) %>%
  mutate(mean_price_bins = mean(price, na.rm=T)) # Take mean price by review bin
# Scatterplot of average price (by bin) vs. number of reviews
price_to_reviews <- ggplot(listing, aes(x = as.factor(bins), y = mean_price_bins, color = mean_price_bins)) + 
  geom_point() +
  theme_bw() +
  labs(x = "Number of Reviews",
       y = "Mean Price (by bin)",
       color = "Price") + 
  theme(axis.text.x = element_text(size = 7)) 
print(price_to_reviews + ggtitle("Mean Price (by bin) vs. Number of Reviews")) # Print scatterplot with title
cor(listings$number_of_reviews, listings$price, method = c("pearson"))
```

Based on the scatterplot, there does not appear to be a strong, linear relationship between mean price (by bin) and number of reviews. This weak relationship between price and number of reviews is confirmed by the correlation of -0.13.

``` {r price_to_review_to_room, echo=F, warning=F}
# Scatterplot of price by number of reviews by room type
price_to_reviews_to_room <- ggplot(listing, aes(x = number_of_reviews, y = price, color = room_type)) +
  geom_point() + 
  theme_bw() +
  labs(x = "Number of Reviews",
       y = "Price",
       color = "Room Type")
print(price_to_reviews_to_room + facet_grid(.~room_type) + ggtitle("Scatterplot of Price by Number of Reviews")) # Print scatterplot with title

```

Given the inconclusive results of the last scatterplot, we considered that given our previous tests found such a strong relationship between room type and price, this could have an impact on the number of reviews. Therefore, we chose to extend our analysis further by segmenting our data by the three room types for this scatterplot of number of reviews by price. In this new scatterplot, it is clear that the shared room room type has a vastly different distribution of price by number of reviews than the entire home/apartment room type.  

Taking our analysis of price and number of reviews one more step further, we ran an ANOVA test for price, binning the number of reviews by the following strata:
  0 - 150
  151 - 300
  301 - 450
  451 - 600
  601 - 750

In binning the number of reviews, we compared the mean prices of the least popular listings with the most popular listings. As a result, we got the statistically significant p-value of 6.27e-05. Therefore, we reject the null hypothesis that there is no difference in means of these five bins of number of reviews. However, when we compared each bin of number of reviews by the other, to see if there is a difference between the least popular and most popular listings, the only statistically significant mean prices were between 151 - 300 and 0 - 150  as well as 301 - 450 and 0 - 150. These results are surprising, as there was no statistically significant  difference in the mean prices of the most popular and least popular Airbnb listings as we had initially thought. 

To verify these results, we also ran a Welch Two-Sample t-test, binning the number of reviews in half, with one bin smaller than 375 reviews and the other bin greater than 375 reviews. The p-value of 7.88e-15 is statistically significant we reject the null hypothesis that the true difference in mean price by number of reviews is zero, which confirms the results of the previous ANOVA test and differs from the results of the Tukey test.

```{r, echo=FALSE, include=T}
listing <- read.csv("listings.csv")
price_number_of_reviews <- ggplot(listing, aes(x=price, y=number_of_reviews, color = price)) +
  geom_point() +
  theme_bw() +
  labs(x = "Number of Reviews",
       y = "Price",
       color = "Price")
print(price_number_of_reviews + ggtitle("Scatterplot of Prices vs. Number of Reviews"))

dataa<- listing
outliers <- boxplot(dataa$price, plot=FALSE)$out
dataa <- dataa[-which(dataa$price %in% outliers),]

dataa$number_of_reviews [dataa$number_of_reviews<=150]<- "0 - 150"
dataa$number_of_reviews [dataa$number_of_reviews>=151 & dataa$number_of_reviews<=300]<- "151 - 300"
dataa$number_of_reviews [dataa$number_of_reviews>=301 & dataa$number_of_reviews<=450]<- "301 - 450"
dataa$number_of_reviews [dataa$number_of_reviews>=451 & dataa$number_of_reviews<=600]<- "451 - 600"
dataa$number_of_reviews [dataa$number_of_reviews>=601 & dataa$number_of_reviews<=750]<- "601 - 750"

boxplot_price_reviews <- ggplot(dataa, aes(x=number_of_reviews, y=price, color=number_of_reviews)) + 
  geom_boxplot() + 
  theme_bw() +
  labs(x = "Number of Reviews",
       y = "Price",
       color = "Number of Reviews")
print(boxplot_price_reviews + ggtitle("Boxplot of Price vs. Number of Reviews"))

anova.test <-  aov(price~as.factor(number_of_reviews), data=dataa)
pander(anova.test)
tukey <- TukeyHSD(anova.test)
tukey
smaller375<- subset(dataa, number_of_reviews <= 375)
greater375<- subset(dataa, number_of_reviews >= 376)
res<- t.test(smaller375$price, greater375$price)
pander(res)
```

## 3.5 Are room types independent of neighborhoods?

Now switching our attention to our categorical variables, we sought to test whether neighborhoods were independent of room type. Based on our Pearson's Chi-squared test of independence, we found the statistically significant p-value of 2.2e-16. Therefore, we reject the null hypothesis that there is a relationship between neighborhood and room type and determine that they are independent variables. 

```{r, echo=FALSE, include=TRUE, warning=F}
#data<- read.csv(file="Aibnb_listings.csv", header = TRUE)
str(data)
table <- table(listings$neighbourhood, listings$room_type)
chi.test=chisq.test(table)
chi.test
```

